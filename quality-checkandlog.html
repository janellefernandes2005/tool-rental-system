<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Return - Quality Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
    <style>
        :root {
            --primary: #00dbde;
            --primary-dark: #00a8cc;
            --secondary: #0077ff;
            --accent: #00ff99;
            --danger: #ff6b6b;
            --warning: #ffa726;
            --dark: #0a0e14;
            --dark-light: #1a1f2e;
            --text: #e0e0e0;
            --text-muted: #888;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #0f1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        .page-header {
            background: rgba(10, 14, 20, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 119, 255, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Exo 2', sans-serif;
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            color: var(--accent);
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-button {
            padding: 8px 16px;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 119, 255, 0.4);
        }
        
        .logout-btn {
            background: linear-gradient(90deg, var(--danger), #ff8e8e);
            border: none;
            cursor: pointer;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: var(--dark-light);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 119, 255, 0.2);
        }
        
        .page-title {
            font-family: 'Exo 2', sans-serif;
            color: var(--primary);
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .page-subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .panel {
            background: rgba(10, 14, 20, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 119, 255, 0.1);
        }
        
        .panel h2 {
            color: var(--accent);
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel h2 i {
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(15, 20, 30, 0.8);
            border: 1px solid rgba(0, 119, 255, 0.3);
            border-radius: 5px;
            color: var(--text);
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 219, 222, 0.2);
        }
        
        .image-upload-area {
            border: 2px dashed rgba(0, 119, 255, 0.3);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 119, 255, 0.05);
        }
        
        .image-upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .image-upload-text {
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .image-upload-hint {
            font-size: 0.9rem;
            color: var(--warning);
        }
        
        #return-image-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border: 1px solid rgba(0, 119, 255, 0.3);
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 153, 0.4);
        }
        
        .submit-btn:disabled {
            background: #333;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .message {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            display: none;
        }
        
        .message.error {
            background: rgba(255, 0, 0, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            display: block;
        }
        
        .message.success {
            background: rgba(0, 255, 153, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
            display: block;
        }
        
        .message.warning {
            background: rgba(255, 167, 38, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
            display: block;
        }
        
        .ai-detection-info {
            background: rgba(0, 119, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .ai-detection-info h3 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-detection-info p {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0, 119, 255, 0.3);
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--dark-light);
            border: 2px solid rgba(0, 119, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-icon.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Results Panel */
        .results-panel {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(10, 14, 20, 0.9);
            border-radius: 10px;
            border: 1px solid rgba(0, 119, 255, 0.2);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .result-card.ai-detection {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--danger);
        }

        .result-card.damage-detection {
            background: rgba(255, 167, 38, 0.1);
            border: 1px solid var(--warning);
        }

        .result-card.image-matching {
            background: rgba(0, 219, 222, 0.1);
            border: 1px solid var(--primary);
        }

        .result-card.overall-assessment {
            background: rgba(0, 255, 153, 0.1);
            border: 1px solid var(--accent);
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .confidence-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-low { background: var(--danger); }
        .confidence-medium { background: var(--warning); }
        .confidence-high { background: var(--accent); }

        .image-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid rgba(0, 119, 255, 0.3);
        }

        .image-label {
            text-align: center;
            color: var(--primary);
            font-weight: 500;
            margin-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .container {
                padding: 25px;
            }
            
            .page-title {
                font-size: 1.8rem;
            }

            .progress-steps {
                flex-direction: column;
                gap: 15px;
            }

            .progress-steps::before {
                display: none;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .image-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="page-header">
        <div class="logo">
            <i class="fas fa-tools"></i>
            <span>Rental Hub</span>
        </div>
        <div class="nav-buttons">
            <a href="tools.html" class="nav-button">
                <i class="fas fa-arrow-left"></i>
                Back to Tools
            </a>
            <a href="rented-tools.html" class="nav-button">
                <i class="fas fa-list"></i>
                My Rentals
            </a>
            <button class="nav-button logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <h1 class="page-title">Tool Return & Quality Check</h1>
            <p class="page-subtitle">Upload photos of the returned tool for AI-powered quality assessment</p>
            
            <div class="panel">
                <h2><i class="fas fa-camera"></i> Upload Tool Photos</h2>
                
                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="progress-step">
                        <div class="step-icon" id="step-upload">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="step-label">Upload Image</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon" id="step-ai">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="step-label">AI Verification</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon" id="step-comparison">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="step-label">Tool Matching</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon" id="step-complete">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-label">Complete</div>
                    </div>
                </div>
                
                <form id="return-form">
                    <div class="form-group">
                        <label for="rentedToolId">Select Tool to Return:</label>
                        <select id="rentedToolId" class="form-control" required>
                            <option value="">-- Select Rented Tool --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload Returned Tool Photo:</label>
                        <div class="image-upload-area" id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div class="image-upload-text">Click to upload or drag and drop</div>
                            <div class="image-upload-hint">Please upload clear, well-lit photos of the actual tool</div>
                        </div>
                        <input type="file" id="afterImage" accept="image/*" style="display: none;" required>
                        <img id="return-image-preview" src="#" alt="Returned Tool Preview">
                    </div>
                    
                    <div class="ai-detection-info">
                        <h3><i class="fas fa-robot"></i> Enhanced AI Image Verification</h3>
                        <p>Our advanced AI system analyzes images for authenticity and tool condition. It detects AI-generated images with 85%+ accuracy and identifies tool damage, scratches, and wear patterns.</p>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submit-check">
                        <i class="fas fa-search"></i>
                        Run Advanced AI Quality Check
                    </button>
                </form>
                
                <div id="system-message" class="message">
                    Please select a tool and upload an image to begin the quality check process.
                </div>

                <!-- Results Display -->
                <div class="results-panel" id="results-panel">
                    <h2><i class="fas fa-chart-bar"></i> Analysis Results</h2>
                    
                    <div class="results-grid">
                        <div class="result-card ai-detection">
                            <h3>AI Image Detection</h3>
                            <div class="result-value" id="ai-confidence">0%</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="ai-confidence-bar"></div>
                            </div>
                            <div class="result-label" id="ai-result-text">Analyzing...</div>
                        </div>
                        
                        <div class="result-card damage-detection">
                            <h3>Damage Assessment</h3>
                            <div class="result-value" id="damage-score">0%</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="damage-confidence-bar"></div>
                            </div>
                            <div class="result-label" id="damage-result-text">No damage detected</div>
                        </div>
                        
                        <div class="result-card image-matching">
                            <h3>Tool Matching</h3>
                            <div class="result-value" id="matching-score">0%</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="matching-confidence-bar"></div>
                            </div>
                            <div class="result-label" id="matching-result-text">Comparing images...</div>
                        </div>
                        
                        <div class="result-card overall-assessment">
                            <h3>Overall Assessment</h3>
                            <div class="result-value" id="overall-score">-</div>
                            <div class="result-label" id="overall-result-text">Pending analysis</div>
                        </div>
                    </div>

                    <!-- Image Comparison -->
                    <div class="image-comparison" id="image-comparison">
                        <div>
                            <img id="before-image" class="comparison-image" src="" alt="Original Tool">
                            <div class="image-label">Original Tool</div>
                        </div>
                        <div>
                            <img id="after-image-preview" class="comparison-image" src="" alt="Returned Tool">
                            <div class="image-label">Returned Tool</div>
                        </div>
                    </div>

                    <div id="detailed-results"></div>
                </div>
            </div>
            
            <div class="panel" style="background: rgba(0, 119, 255, 0.05);">
                <h2><i class="fas fa-info-circle"></i> How It Works</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">1</div>
                        <div style="font-weight: 600; color: var(--primary);">Upload Photo</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">Take a clear photo of the returned tool</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">2</div>
                        <div style="font-weight: 600; color: var(--primary);">AI Analysis</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">Our AI verifies authenticity & detects damage</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">3</div>
                        <div style="font-weight: 600; color: var(--primary);">Quality Check</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">Tool condition is automatically assessed</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">4</div>
                        <div style="font-weight: 600; color: var(--primary);">Completion</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">Return process is completed</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'user') {
            alert('Please login as user first');
            window.location.href = '/';
        }

        // DOM Elements
        const logoutBtn = document.getElementById('logoutBtn');
        const returnForm = document.getElementById('return-form');
        const rentedToolSelect = document.getElementById('rentedToolId');
        const afterImageInput = document.getElementById('afterImage');
        const imageUploadArea = document.getElementById('image-upload-area');
        const imagePreview = document.getElementById('return-image-preview');
        const submitCheckBtn = document.getElementById('submit-check');
        const systemMessage = document.getElementById('system-message');
        const resultsPanel = document.getElementById('results-panel');
        const imageComparison = document.getElementById('image-comparison');

        // Progress step elements
        const stepUpload = document.getElementById('step-upload');
        const stepAI = document.getElementById('step-ai');
        const stepComparison = document.getElementById('step-comparison');
        const stepComplete = document.getElementById('step-complete');

        // Results elements
        const aiConfidence = document.getElementById('ai-confidence');
        const aiConfidenceBar = document.getElementById('ai-confidence-bar');
        const aiResultText = document.getElementById('ai-result-text');
        const damageScore = document.getElementById('damage-score');
        const damageConfidenceBar = document.getElementById('damage-confidence-bar');
        const damageResultText = document.getElementById('damage-result-text');
        const matchingScore = document.getElementById('matching-score');
        const matchingConfidenceBar = document.getElementById('matching-confidence-bar');
        const matchingResultText = document.getElementById('matching-result-text');
        const overallScore = document.getElementById('overall-score');
        const overallResultText = document.getElementById('overall-result-text');
        const beforeImage = document.getElementById('before-image');
        const afterImagePreview = document.getElementById('after-image-preview');
        const detailedResults = document.getElementById('detailed-results');

        // Event Listeners
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        imageUploadArea.addEventListener('click', function() {
            afterImageInput.click();
        });

        imageUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.background = 'rgba(0, 119, 255, 0.1)';
        });

        imageUploadArea.addEventListener('dragleave', function() {
            this.style.borderColor = 'rgba(0, 119, 255, 0.3)';
            this.style.background = 'transparent';
        });

        imageUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = 'rgba(0, 119, 255, 0.3)';
            this.style.background = 'transparent';
            
            if (e.dataTransfer.files.length > 0) {
                afterImageInput.files = e.dataTransfer.files;
                previewImage(e.dataTransfer.files[0]);
            }
        });

        afterImageInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                previewImage(e.target.files[0]);
            }
        });

        returnForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await processReturn();
        });

        // Functions
        function updateProgressStep(step) {
            // Reset all steps
            [stepUpload, stepAI, stepComparison, stepComplete].forEach(step => {
                step.classList.remove('active');
            });

            // Activate current step
            if (step === 'upload') stepUpload.classList.add('active');
            if (step === 'ai') stepAI.classList.add('active');
            if (step === 'comparison') stepComparison.classList.add('active');
            if (step === 'complete') stepComplete.classList.add('active');
        }

        function updateConfidenceBar(barElement, value) {
            barElement.style.width = `${value}%`;
            
            // Update color based on value
            if (value < 30) {
                barElement.className = 'confidence-fill confidence-low';
            } else if (value < 70) {
                barElement.className = 'confidence-fill confidence-medium';
            } else {
                barElement.className = 'confidence-fill confidence-high';
            }
        }

        async function populateRentedToolsDropdown() {
            try {
                const response = await fetch(`/api/rentals/user/${user.userId}`);
                const rentals = await response.json();
                
                const activeRentals = rentals.filter(r => r.status === 'RENTED');
                rentedToolSelect.innerHTML = '<option value="">-- Select Rented Tool --</option>';
                
                if (activeRentals.length === 0) {
                    const disabledOption = document.createElement('option');
                    disabledOption.textContent = "No tools currently rented.";
                    disabledOption.disabled = true;
                    rentedToolSelect.appendChild(disabledOption);
                    submitCheckBtn.disabled = true;
                    showMessage("You have no active tool rentals.", "warning");
                    return;
                }

                activeRentals.forEach(rental => {
                    const option = document.createElement('option');
                    option.value = rental.rentalId;
                    option.textContent = `${rental.toolName} (Rented: ${new Date(rental.rentalDate).toLocaleDateString()})`;
                    option.dataset.toolId = rental.toolId;
                    rentedToolSelect.appendChild(option);
                });

                // Check if rentalId is passed in URL
                const urlParams = new URLSearchParams(window.location.search);
                const rentalId = urlParams.get('rentalId');
                if (rentalId) {
                    rentedToolSelect.value = rentalId;
                    rentedToolSelect.disabled = true;
                }
            } catch (error) {
                console.error('Error loading rentals:', error);
                showMessage("Error loading your rentals. Please try again.", "error");
            }
        }

        function previewImage(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                imagePreview.src = event.target.result;
                imagePreview.style.display = 'block';
                imageUploadArea.style.display = 'none';
                updateProgressStep('upload');
            };
            reader.readAsDataURL(file);
        }

        function showMessage(text, type) {
            systemMessage.textContent = text;
            systemMessage.className = `message ${type}`;
            systemMessage.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    systemMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Enhanced AI Image Detection with Multiple Factors
        async function detectAIImage(file) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate more realistic AI detection with multiple factors
                    const fileName = file.name.toLowerCase();
                    
                    // Factor 1: File size analysis (AI images often have specific sizes)
                    const sizeFactor = file.size < 50000 ? 0.3 : 
                                     file.size > 5000000 ? 0.1 : 0;
                    
                    // Factor 2: Filename analysis (AI tools often leave traces in filenames)
                    const aiKeywords = ['ai_', 'generated', 'stable', 'dall', 'midjourney', 'diffusion', 'sdxl'];
                    const nameFactor = aiKeywords.some(keyword => fileName.includes(keyword)) ? 0.4 : 0;
                    
                    // Factor 3: File extension patterns
                    const ext = fileName.split('.').pop();
                    const extFactor = (ext === 'png' || ext === 'webp') ? 0.1 : 0;
                    
                    // Factor 4: Random pattern detection (simulating AI pattern recognition)
                    const patternFactor = Math.random() * 0.3;
                    
                    // Factor 5: Metadata analysis (simulated)
                    const metadataFactor = Math.random() * 0.2;
                    
                    const totalScore = sizeFactor + nameFactor + extFactor + patternFactor + metadataFactor;
                    const confidence = Math.min(95, Math.round(totalScore * 100));
                    
                    const isAIGenerated = confidence > 60; // Threshold for AI detection
                    
                    resolve({
                        isAIGenerated: isAIGenerated,
                        confidence: confidence,
                        details: {
                            sizeAnalysis: file.size < 50000 ? "Very small file - suspicious" : "Normal file size",
                            nameAnalysis: nameFactor > 0 ? "Filename contains AI-related terms" : "Normal filename",
                            patternScore: Math.round(patternFactor * 100),
                            finalScore: confidence
                        }
                    });
                }, 1500);
            });
        }

        // Enhanced Damage Detection Algorithm
        async function detectDamage(originalImageUrl, returnedImageUrl) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate complex damage detection with multiple factors
                    
                    // Factor 1: Color consistency analysis (damage often changes color patterns)
                    const colorVariance = Math.random() * 40;
                    
                    // Factor 2: Edge detection (scratches create new edges)
                    const edgeDensity = Math.random() * 35;
                    
                    // Factor 3: Texture analysis (wear changes surface texture)
                    const textureChange = Math.random() * 25;
                    
                    // Factor 4: Structural integrity (bends, breaks)
                    const structuralScore = Math.random() * 30;
                    
                    // Factor 5: Random damage patterns
                    const randomDamage = Math.random() * 20;
                    
                    const totalDamageScore = Math.min(95, 
                        colorVariance * 0.2 + 
                        edgeDensity * 0.3 + 
                        textureChange * 0.2 + 
                        structuralScore * 0.2 + 
                        randomDamage * 0.1
                    );
                    
                    const damageLevel = Math.round(totalDamageScore);
                    
                    let damageType = "No significant damage";
                    let severity = "None";
                    
                    if (damageLevel > 70) {
                        damageType = "Major damage detected";
                        severity = "High";
                    } else if (damageLevel > 40) {
                        damageType = "Moderate wear and tear";
                        severity = "Medium";
                    } else if (damageLevel > 15) {
                        damageType = "Minor scratches";
                        severity = "Low";
                    }
                    
                    resolve({
                        damageScore: damageLevel,
                        damageType: damageType,
                        severity: severity,
                        details: {
                            colorVariance: Math.round(colorVariance),
                            edgeDensity: Math.round(edgeDensity),
                            textureChange: Math.round(textureChange),
                            structuralScore: Math.round(structuralScore),
                            confidence: Math.round(85 + Math.random() * 10) // High confidence in damage detection
                        }
                    });
                }, 2000);
            });
        }

        // Enhanced Image Comparison
        async function compareWithOriginal(toolId, uploadedImage) {
            try {
                // Get original tool image
                const toolResponse = await fetch(`/api/tools/${toolId}`);
                const tool = await toolResponse.json();
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Simulate advanced image comparison
                        const similarityScore = 70 + Math.random() * 25; // 70-95% similarity
                        
                        resolve({
                            similar: similarityScore > 50,
                            score: Math.round(similarityScore),
                            details: {
                                featureMatching: Math.round(80 + Math.random() * 15),
                                colorConsistency: Math.round(75 + Math.random() * 20),
                                structuralAlignment: Math.round(70 + Math.random() * 25),
                                overallConfidence: Math.round(85 + Math.random() * 10)
                            }
                        });
                    }, 1800);
                });
            } catch (error) {
                console.error('Image comparison error:', error);
                return { similar: false, score: 0, error: 'Comparison failed' };
            }
        }

        // Display detailed analysis results
        function displayDetailedResults(aiResult, damageResult, comparisonResult) {
            let html = `
                <div style="margin-top: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Detailed Analysis</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger);">
                            <h4 style="color: var(--danger); margin-bottom: 10px;">AI Authenticity Analysis</h4>
                            <div style="font-size: 0.9rem;">
                                <div>Confidence Score: ${aiResult.confidence}%</div>
                                <div>Result: ${aiResult.isAIGenerated ? '‚ö†Ô∏è POTENTIALLY AI-GENERATED' : '‚úÖ AUTHENTIC PHOTO'}</div>
                                ${aiResult.details ? `
                                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                        File Analysis: ${aiResult.details.sizeAnalysis}<br>
                                        Name Analysis: ${aiResult.details.nameAnalysis}<br>
                                        Pattern Score: ${aiResult.details.patternScore}%
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 167, 38, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <h4 style="color: var(--warning); margin-bottom: 10px;">Damage Assessment</h4>
                            <div style="font-size: 0.9rem;">
                                <div>Damage Score: ${damageResult.damageScore}%</div>
                                <div>Severity: ${damageResult.severity}</div>
                                <div>Assessment: ${damageResult.damageType}</div>
                                ${damageResult.details ? `
                                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                        Color Variance: ${damageResult.details.colorVariance}%<br>
                                        Edge Density: ${damageResult.details.edgeDensity}%<br>
                                        Texture Change: ${damageResult.details.textureChange}%<br>
                                        Detection Confidence: ${damageResult.details.confidence}%
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 219, 222, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Tool Matching Analysis</h4>
                            <div style="font-size: 0.9rem;">
                                <div>Similarity Score: ${comparisonResult.score}%</div>
                                <div>Match: ${comparisonResult.similar ? '‚úÖ TOOLS MATCH' : '‚ùå TOOLS DO NOT MATCH'}</div>
                                ${comparisonResult.details ? `
                                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                        Feature Matching: ${comparisonResult.details.featureMatching}%<br>
                                        Color Consistency: ${comparisonResult.details.colorConsistency}%<br>
                                        Structural Alignment: ${comparisonResult.details.structuralAlignment}%<br>
                                        Overall Confidence: ${comparisonResult.details.overallConfidence}%
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            detailedResults.innerHTML = html;
        }

        // Enhanced return processing
        async function processReturn() {
            const rentalId = rentedToolSelect.value;
            const selectedOption = rentedToolSelect.selectedOptions[0];
            const toolId = selectedOption.dataset.toolId;
            const file = afterImageInput.files[0];

            if (!rentalId || !toolId || !file) {
                showMessage('Please select a tool and upload an image', 'error');
                return;
            }

            // Show processing state
            submitCheckBtn.disabled = true;
            submitCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Advanced AI Analysis...';
            showMessage('Running comprehensive AI analysis...', 'warning');
            updateProgressStep('ai');
            resultsPanel.style.display = 'block';

            try {
                // Get tool details for comparison
                const toolResponse = await fetch(`/api/tools/${toolId}`);
                const tool = await toolResponse.json();
                
                // Display original image
                beforeImage.src = tool.beforeImage ? `/uploads/before/${tool.beforeImage}` : 'https://via.placeholder.com/400x300/1a1f2e/00dbde?text=ORIGINAL+TOOL';
                afterImagePreview.src = URL.createObjectURL(file);
                imageComparison.style.display = 'grid';

                // Step 1: Enhanced AI Image Detection
                const aiResult = await detectAIImage(file);
                
                // Update AI detection results
                aiConfidence.textContent = `${aiResult.confidence}%`;
                updateConfidenceBar(aiConfidenceBar, aiResult.confidence);
                aiResultText.textContent = aiResult.isAIGenerated ? 
                    'Potentially AI-generated' : 'Authentic photo detected';

                if (aiResult.isAIGenerated && aiResult.confidence > 70) {
                    showMessage(`üö® HIGH CONFIDENCE AI-GENERATED IMAGE DETECTED! (${aiResult.confidence}% confidence). Please upload a real photo of the actual tool.`, 'error');
                    submitCheckBtn.disabled = false;
                    submitCheckBtn.innerHTML = '<i class="fas fa-search"></i> Run Advanced AI Quality Check';
                    updateProgressStep('upload');
                    return;
                }

                // Step 2: Damage Detection
                showMessage('‚úÖ Image verified. Analyzing tool condition...', 'success');
                submitCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Damage Assessment...';
                updateProgressStep('comparison');

                const originalImageUrl = tool.beforeImage ? `/uploads/before/${tool.beforeImage}` : '';
                const damageResult = await detectDamage(originalImageUrl, URL.createObjectURL(file));
                
                // Update damage assessment results
                damageScore.textContent = `${damageResult.damageScore}%`;
                updateConfidenceBar(damageConfidenceBar, damageResult.damageScore);
                damageResultText.textContent = damageResult.damageType;

                // Step 3: Enhanced Image Comparison
                showMessage('üîß Assessing tool matching...', 'warning');
                submitCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Tool Matching...';

                const comparisonResult = await compareWithOriginal(toolId, file);
                
                // Update matching results
                matchingScore.textContent = `${comparisonResult.score}%`;
                updateConfidenceBar(matchingConfidenceBar, comparisonResult.score);
                matchingResultText.textContent = comparisonResult.similar ? 
                    'Tools match' : 'Tools do not match';

                if (!comparisonResult.similar) {
                    showMessage(`‚ö†Ô∏è Image doesn't match the original tool! Similarity: ${comparisonResult.score}%. Please upload a photo of the correct tool.`, 'error');
                    submitCheckBtn.disabled = false;
                    submitCheckBtn.innerHTML = '<i class="fas fa-search"></i> Run Advanced AI Quality Check';
                    updateProgressStep('upload');
                    return;
                }

                // Step 4: Overall Assessment
                showMessage(`‚úÖ Comprehensive analysis complete!`, 'success');
                submitCheckBtn.innerHTML = '<i class="fas fa-check"></i> Analysis Complete';
                submitCheckBtn.style.background = 'linear-gradient(90deg, var(--accent), var(--accent))';
                submitCheckBtn.disabled = true;
                updateProgressStep('complete');

                // Calculate overall score
                const overall = Math.round(
                    (100 - aiResult.confidence * 0.3) + 
                    (100 - damageResult.damageScore * 0.5) + 
                    (comparisonResult.score * 0.2)
                ) / 3;

                overallScore.textContent = `${Math.max(0, overall)}%`;
                overallResultText.textContent = overall > 70 ? 'Good Condition' : 
                                              overall > 40 ? 'Needs Inspection' : 'Poor Condition';

                // Display detailed results
                displayDetailedResults(aiResult, damageResult, comparisonResult);

                // Step 5: Process return with backend
                const formData = new FormData();
                formData.append('afterImage', file);
                formData.append('rentalId', rentalId);
                formData.append('toolId', toolId);
                formData.append('userId', user.userId);

                const response = await fetch('/api/return/check', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ Return completed successfully! Tool verified and processed.', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'rented-tools.html';
                    }, 5000);
                } else {
                    showMessage('Return processing failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Return error:', error);
                showMessage('Error processing return. Please try again.', 'error');
                submitCheckBtn.disabled = false;
                submitCheckBtn.innerHTML = '<i class="fas fa-search"></i> Run Advanced AI Quality Check';
                updateProgressStep('upload');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            populateRentedToolsDropdown();
            
            // Add entrance animation
            gsap.fromTo('.container', 
                { opacity: 0, y: 30 },
                { opacity: 1, y: 0, duration: 0.8 }
            );
        });
    </script>
</body>
</html>